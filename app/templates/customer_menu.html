{% extends "base.html" %}
{% block content %}
<div class="d-flex align-items-start justify-content-between gap-2">
    <div>
        <h4 class="mb-0">เมนู ({{ table.name }})</h4>
        <div class="text-muted small">สแกนแล้วสั่งได้เลย</div>
    </div>
    <a class="btn btn-outline-light btn-sm" href="/t/{{ table.token }}/status">สถานะโต๊ะ</a>
</div>

{# ✅ บิลล่าสุด (โชว์ครั้งเดียวพอ) #}
{% if orders and orders|length %}
<div class="card mt-3 shadow-sm">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <div class="fw-bold">บิลล่าสุด</div>
            <a class="btn btn-outline-primary btn-sm" href="/t/{{ table.token }}/status">ดูทั้งหมด</a>
        </div>

        <div class="vstack gap-2 mt-2">
            {% for o in orders %}
            <div class="border rounded p-2">
                <div class="d-flex justify-content-between">
                    <div class="fw-bold">Order #{{ o.id }}</div>
                    <div class="small text-muted">฿{{ '%.2f'|format(o.total_amount) }}</div>
                </div>

                <div class="small text-muted">Ref: {{ o.invoice_ref }}</div>

                <div class="small mt-1 d-flex gap-2 flex-wrap align-items-center">
                    <span class="badge {% if o.payment and o.payment.status=='paid' %}text-bg-success{% else %}text-bg-warning{% endif %}">
                        {{ o.payment.status if o.payment else 'unpaid' }}
                    </span>
                    <span class="badge text-bg-secondary">{{ o.order_status if o.order_status else 'new' }}</span>

                    <a class="btn btn-sm btn-outline-primary ms-auto" href="/t/{{ table.token }}/pay/{{ o.id }}">
                        ไปหน้าชำระเงิน
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>

    </div>
</div>
{% endif %}

<div class="card mt-3">
    <div class="card-body">
        <div class="row g-2 align-items-center">
            <div class="col-12 col-md-6">
                <input id="searchBox" class="form-control" placeholder="ค้นหาเมนู..." />
            </div>
            <div class="col-12 col-md-6">
                <select id="catSelect" class="form-select">
                    <option value="">ทุกหมวด</option>
                    {% for c in categories %}
                    <option value="{{ c }}">{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="mt-3 row g-2" id="menuGrid" data-table-token="{{ table.token }}">
            {% for it in items %}
            <div class="col-12 col-sm-6 col-lg-4 menu-card" data-name="{{ it.name|lower }}" data-cat="{{ it.category }}">
                <div class="card h-100 shadow-sm">
                    {% if it.image_url %}
                    <img src="{{ it.image_url }}" class="card-img-top" alt="{{ it.name }}">
                    {% endif %}
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold">{{ it.name }}</div>
                                <div class="text-muted small">{{ it.category }}</div>
                            </div>
                            <div class="fw-bold">฿{{ '%.2f'|format(it.price) }}</div>
                        </div>
                        {% if it.description %}
                        <div class="text-muted small mt-2">{{ it.description }}</div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-white border-0 pt-0">
                        <button class="btn btn-primary w-100" onclick="Cart.add({{ it.id }}, '{{ it.name|e }}', {{ it.price }})">
                            เพิ่มเข้าตะกร้า
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

    </div>
</div>

<div class="sticky-cart shadow-lg">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <div class="fw-bold">ตะกร้า</div>
            <div class="small text-muted">
                <span id="cartCount">0</span> รายการ • ฿<span id="cartTotal">0.00</span>
            </div>
        </div>
        <a class="btn btn-warning fw-bold" href="/t/{{ table.token }}/checkout">ไปชำระเงิน</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/app.js"></script>
<script>
Cart.init("{{ table.token }}", "{{ cid }}");

// ✅ แก้เคสกดย้อนกลับ: หน้าโดน cache ไว้ ต้อง sync ใหม่
window.addEventListener("pageshow", (e) => {
    Cart.syncUI();
});

// ค้นหา/กรองหมวด
const searchBox = document.getElementById("searchBox");
const catSelect = document.getElementById("catSelect");

function applyFilter() {
    const q = (searchBox.value || "").toLowerCase().trim();
    const c = (catSelect.value || "").trim();

    document.querySelectorAll(".menu-card").forEach(el => {
        const okName = !q || (el.dataset.name || "").includes(q);
        const okCat = !c || (el.dataset.cat || "") === c;
        el.style.display = (okName && okCat) ? "" : "none";
    });
}

searchBox.addEventListener("input", applyFilter);
catSelect.addEventListener("change", applyFilter);
</script>
{% endblock %}
