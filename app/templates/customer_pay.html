{% extends "base.html" %}
{% block content %}
<h4 class="mb-0">ชำระเงิน ({{ table.name }})</h4>
<div class="text-muted small">Order #{{ order.id }} • Ref: <span class="fw-bold">{{ order.invoice_ref }}</span></div>

<div class="row g-3 mt-2">
    <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <div class="fw-bold mb-2">สแกน PromptPay QR</div>

                {% if payment.qr_image_base64 %}
                <img class="qr-img" src="/static/QrKbank.png" alt="QR">
                {% else %}
                <div class="text-muted">ยังไม่มีรูป QR (ตรวจ config/response จาก SCB)</div>
                {% endif %}

                <div class="mt-3">
                  <div class="h5 mb-0">฿{{ '%.2f'|format(order.total_amount) }}</div>
                  <div class="small text-muted">
                      กรุณาใส่ยอดเงินให้ตรงกับบิล
                  </div>
              </div>

                <button id="btnPoll" class="btn btn-outline-primary w-100 mt-3">เช็คสถานะ (fallback)</button>
                <a class="btn btn-outline-secondary w-100 mt-2" href="/t/{{ table.token }}/status">ดูสถานะโต๊ะ</a>
            </div>
            <div class="small text-muted mt-2">
              สถานะ:
              <span id="payStatus" class="badge text-bg-warning">รอยืนยัน</span>
            </div>
            
        </div>
    </div>

    <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="fw-bold">รายการ</div>
                <hr>
                {% for it in order.items %}
                <div class="d-flex justify-content-between">
                    <div>{{ it.menu_item.name }} x{{ it.qty }}</div>
                    <div>฿{{ '%.2f'|format(it.line_total) }}</div>
                </div>
                {% if it.note %}
                <div class="small text-muted">Note: {{ it.note }}</div>
                {% endif %}
                <hr class="my-2">
                {% endfor %}
                {% if order.note %}
                <div class="small text-muted">หมายเหตุรวม: {{ order.note }}</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script src="/static/app.js"></script>
<script>
const orderId = Number({{ order.id }});
const tableToken = "{{ table.token }}";

// -------------------------
// UI helpers
// -------------------------
function ensurePaidModal() {
  if (document.getElementById("paidModal")) return;

  const html = `
  <div class="modal fade" id="paidModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">✅ ชำระเงินเรียบร้อยแล้ว</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div id="receiptBox" class="p-3 border rounded bg-white">
            <div class="fw-bold mb-1">ใบเสร็จ</div>
            <div class="small text-muted mb-2" id="rcpRef">Ref: -</div>

            <div class="d-flex justify-content-between">
              <div class="small text-muted">โต๊ะ</div>
              <div class="small">{{ table.name }}</div>
            </div>

            <hr class="my-2"/>

            <div id="rcpItems" class="small"></div>

            <hr class="my-2"/>

            <div class="d-flex justify-content-between">
              <div class="fw-bold">รวม</div>
              <div class="fw-bold" id="rcpTotal">฿0.00</div>
            </div>

            <div class="small text-muted mt-2" id="rcpNote"></div>
            <div class="small text-muted" id="rcpCreated"></div>
          </div>

          <div class="text-muted small mt-2">
            กด “เซฟรูป” เพื่อบันทึกใบเสร็จลงเครื่อง
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-primary" id="btnSaveReceipt">
            💾 เซฟรูป
          </button>
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">
            กลับหน้าเมนู
          </button>
        </div>
      </div>
    </div>
  </div>`;
  document.body.insertAdjacentHTML("beforeend", html);

  // ปิด modal แล้วเด้งกลับเมนู
  const modalEl = document.getElementById("paidModal");
  modalEl.addEventListener("hidden.bs.modal", () => {
    window.location.href = `/t/${tableToken}`;
  });

  // ปุ่มเซฟรูป (ใช้ html2canvas ถ้ามี / ถ้าไม่มีให้ fallback)
  document.getElementById("btnSaveReceipt").addEventListener("click", async () => {
    const box = document.getElementById("receiptBox");
  
    const canvas = await window.html2canvas(box, { scale: 2 });
    canvas.toBlob(async (blob) => {
      if (!blob) return;
  
      // ✅ มือถือ: ใช้ Share ได้จะดีที่สุด
      const file = new File([blob], `receipt-order-${orderId}.png`, { type: "image/png" });
  
      if (navigator.share && navigator.canShare?.({ files: [file] })) {
        try {
          await navigator.share({ files: [file], title: "Receipt" });
          return;
        } catch {}
      }
  
      // ✅ fallback: เปิดรูปในแท็บใหม่ ให้ user กด Save image เอง
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
      setTimeout(() => URL.revokeObjectURL(url), 30000);
    }, "image/png");
  });
  
}

function setPaidBadgeUI() {
  const el = document.getElementById("payStatus");
  if (!el) return;
  el.className = "badge text-bg-success";
  el.textContent = "ชำระแล้ว";
}

function fillReceipt(data) {
  document.getElementById("rcpRef").textContent = `Ref: ${data.invoice_ref || "-"}`;
  document.getElementById("rcpTotal").textContent = `฿${(data.total || 0).toFixed(2)}`;

  const itemsEl = document.getElementById("rcpItems");
  itemsEl.innerHTML = "";

  (data.items || []).forEach(it => {
    const row = document.createElement("div");
    row.className = "d-flex justify-content-between";
    row.innerHTML = `
      <div>• ${it.name} x${it.qty}${it.note ? `<div class="text-muted small">↳ ${it.note}</div>` : ""}</div>
      <div>฿${Number(it.line_total || 0).toFixed(2)}</div>
    `;
    itemsEl.appendChild(row);
  });

  const note = data.note ? `หมายเหตุ: ${data.note}` : "";
  document.getElementById("rcpNote").textContent = note;

  if (data.created_at) {
    // created_at เป็น ISO UTC → แสดงแบบ local ของมือถือ (ไทย) ด้วย toLocaleString
    const d = new Date(data.created_at);
    document.getElementById("rcpCreated").textContent = `เวลา: ${d.toLocaleString("th-TH")}`;
  } else {
    document.getElementById("rcpCreated").textContent = "";
  }
}

function showPaidFlow(data) {
  setPaidBadgeUI();
  ensurePaidModal();
  fillReceipt(data);

  const modal = new bootstrap.Modal(document.getElementById("paidModal"), { backdrop: "static" });
  modal.show();
}

// -------------------------
// Polling logic (NO WS)
// -------------------------
let paidShown = false;

async function checkStatusOnce() {
  const res = await fetch(`/api/orders/${orderId}/status`, { cache: "no-store" });
  const j = await res.json().catch(() => ({}));
  if (!res.ok || !j.ok) return;

  if (j.payment_status === "paid" && !paidShown) {
    paidShown = true;
    showPaidFlow(j);

    // เคลียร์ cart ด้วย (ถ้าคุณมี Cart)
    try { if (window.Cart && typeof Cart.clear === "function") Cart.clear(); } catch {}
  }
}

async function startPolling() {
  await checkStatusOnce();
  setInterval(checkStatusOnce, 2000); // ทุก 2 วิ
}

startPolling();

// ปุ่ม fallback เช็คสถานะ
document.getElementById("btnPoll")?.addEventListener("click", async () => {
  await checkStatusOnce();
});
</script>


{% endblock %}
